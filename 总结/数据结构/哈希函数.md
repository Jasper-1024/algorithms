# 哈希函数

哈希函数将 key 均匀映射到槽位.是哈希表时间复杂度很小的基础.

这理论上哈希函数应该独立于 key 存在,对于任何 key 的集合都能均匀映射.但是没那么好的事情,常用哈希函数总是有发生哈希碰撞贼高的 key .

一节会提到 3.5 个常用哈希函数.

- 乘法/除法哈希是简单易用.为避免最坏情况,会有参数取值的限制.
- 全域哈希是给哈希函数增加了随机选择,避免最坏情况的 $n^2$ 时间复杂度
- 完全哈希则是另一种思路,根据 key 构造一个最坏情况也是 $O(1)$ 的哈希表,姑且算半个.

ps:

- 这里假设键值都是自然数.字符串等键值也转换到自然数进行 hash 运算.

## 除法哈希函数

最简单的哈希函数

$$
h(k) = k \bmod m
$$

- m 不应该太小,使得装载因子太大.
- m 不应该取 $2^r$,$10^r$.当是这些数时,相当于一直取 key 对应进制下的低位数.
- m 最好是与需求规模差不多的素数.
- 特别要避免 $h(k)$ 一直是偶数.这样一半的哈希表覆盖不到.

## 乘法哈希函数

基本步骤

- k 乘上常数 A $\in(1,0)$,提取 kA 的小数部分.
- m 乘上小数部分,向下取整

$$
h(k) = \lfloor m(kA \bmod 1) \rfloor
$$

- 对 m 取值不敏感.
- A 取值,有些蒙蔽, #todo

下面是课程中提到的乘法哈希函数.应该是二进制下的特别版

$$
h(k) = (Ak \bmod 2^w) rsh (w - r)
$$

- w 是计算机位数
- A 是奇数,在 $(2^{w-r},2^w)$ 之间.不要取 $2^r$ 及其附近值.
- rsh 是向右移位.

## 全域哈希函数

无论是乘法/除法哈希函数,总会有特定的 key 集合使得 hash 函数一直碰撞.既然单一 hash 函数无法避免这个问题,那么随机选取 hash 函数呢?

全域 hash 算每次运行时会从一组 hash 函数中随机选取一个,避免最糟糕情况出现.

设 H  是一组有限哈希函数,它的一个元素哈希函数将给定关键词的全域 U 映射到 {0,1...,m-1}中,我们称这样的函数组 H 是全域的.

任意不同的 k,l ($\in U$),满足 h(k) = h(l) 的散列函数个数至多是 $\frac{|H|}{m}$ ^116744

- $|H| * \frac1m * \frac1m * m = \frac{|H|}{m}$

话句话说从 H 中随机取一个散列函数,当  k,l ($\in U,k \not=l$),h(k) = h(l) 的概率是 $\frac{1}{m}$. ^cd3720


前提: 选择拉链法处理哈希碰撞,使用全域哈希.

n 个 key 放入 m 个槽位,这对于给定的关键字 X 发生碰撞的概率的期望小于 $\frac{n}{m} = \alpha$.

证明: 

---
轻车熟路了,有概率有期望.--> [[指示器随机变量]].

这里无法直接使用 [[指示器随机变量]],需要将求解拆分成 $\sum$ [[指示器随机变量]].

---

假设 $C_X$ 是哈希表 T 中 key 与 X 碰撞的总次数.$E[C_X]$ 是我们要求解的结果.

设 $C_{xy}$ 是指示器随机变量.

$$
C_{xy} = \begin{cases}
& 1, xy发生碰撞\\
& 0, xy没有碰撞
\end{cases}
$$

由 [[#^116744]] 可以知道 $E[C_{xy}] = \frac1m$.

由定义可得

$$
C_X = \sum_{y\not=x}^{y\in T}  C_{xy}
$$

两边取期望

$$
\begin{aligned}
E[C_X] & = E[\sum_{y\not=x}^{y\in T}  C_{xy}] \\
& = \sum_{y\not=x}^{y\in T} E[C_{xy}] \\
& = \frac1m  \sum_{y\not=x}^{y\in T} 1 \\
& = \frac{n-1}{m}
\end{aligned}
$$

### 构造完全哈希

**方法不唯一**,且证明涉及到数论,略...

#todo 

证明略...

## 完全哈希

问题: 对于 n 个 key 如何创建静态表,实现最坏情况下查找 $O(1)$?

最坏情况下,影响最大的还是哈希碰撞.但即使是选择全域哈希函数,碰撞依旧是不可避免.

除了从哈希函数下手外,直观上还可以增大 m,虽然付出的很大空间代价,但是确实能证明哈希碰撞的期望小于 1.

设 $m = n^2$,从全域哈希函数种随机选择,我们能证明其碰撞的期望小于 $\frac12$.

证明

- n 个 key 任取两个发生碰撞时,总共有 $C_n^2 = \frac{n(n-1)}{2}$ 种情况.
- 由 [[#^cd3720]] 可得,给定两个 key,从全域哈希函数种随机选择哈希函数,其发生碰撞的概率是 $\frac{1}{m} = \frac{1}{n^2}$

$$
E[碰撞] = \frac{n(n-1)}{2}*\frac{1}{n^2} < \frac12
$$

根据 [[马尔可夫不等式]],将上面的期望转换成概率.

$$
Pr\{x \geq 1\}
$$




这里公开课提到了一种构造方法

- 一级 hash 碰撞始终不可避免,那么两级呢?如果第二级能避开碰撞,进行两次 hash 依旧是 $O(1)$.
- 第一级的 hash 也不能随便选,上一节的全域 Hash 是最后的选择.

使用两级结构,都是全域 Hash

- 假设第一级的槽中有 $n_i$ 个元素,那么对应第二级会有 $n_i^2$ 个空间.
- 最后得到一个类似拉链法的两级结构.

我们要证明的是能够找到第二级不发生碰撞的哈希函数概率很高.

对于第二级而言,$m = n^2$,哈希函数是全域哈希时,其碰撞的期望小于 $\frac12$.

证明:

- n 个 key 发生碰撞时,总共有 $C_n^2 = \frac{n(n-1)}{2}$ 种情况.
- 